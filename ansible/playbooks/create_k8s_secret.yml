---
- name: Create Kubernetes Infisical Secret and update Kustomization
  hosts: localhost
  connection: local # Run locally to interact with local files and kubectl

  vars:
    k8s_secrets_base_path: "/home/mohammad/k8s-cluster/secrets"
    infisical_host_api: "http://infisical-infisical-standalone-infisical.vault.svc.cluster.local:8080/api"
    universal_auth_secret_name: "universal-auth-credentials"
    universal_auth_secret_namespace: "vault"

  vars_prompt:
    - name: "secret_name_base"
      prompt: "Enter the base name for the Infisical Secret (e.g., ddg-search)"
      private: false
    - name: "secret_namespace"
      prompt: "Enter the Kubernetes namespace for the secret (e.g., ddg-search)"
      private: false
    - name: "project_slug"
      prompt: "Enter the Infisical project slug (e.g., ddg-search-d-uw-6)"
      private: false
    - name: "env_slug"
      prompt: "Enter the Infisical environment slug (e.g., staging, dev, prod)"
      private: false
      default: "staging"
    - name: "secrets_path"
      prompt: "Enter the Infisical secrets path (e.g., /, /my-app)"
      private: false
      default: "/"

  tasks:
    - name: Construct managed secret name
      ansible.builtin.set_fact:
        managed_secret_name: "managed-{{ secret_name_base }}-secret"
        secret_filename: "{{ secret_name_base }}-infisical-secret.yml"

    - name: Debug - User input and constructed variables
      ansible.builtin.debug:
        msg:
          - "Base Secret Name: {{ secret_name_base }}"
          - "Namespace: {{ secret_namespace }}"
          - "Project Slug: {{ project_slug }}"
          - "Env Slug: {{ env_slug }}"
          - "Secrets Path: {{ secrets_path }}"
          - "Managed Secret Name: {{ managed_secret_name }}"
          - "Secret Filename: {{ secret_filename }}"
        verbosity: 1

    - name: Check if Kubernetes namespace '{{ secret_namespace }}' exists
      ansible.builtin.command: "kubectl get namespace {{ secret_namespace }}"
      register: namespace_check
      changed_when: false
      failed_when: false

    - name: Prompt to create namespace if it does not exist
      ansible.builtin.pause:
        prompt: "Namespace '{{ secret_namespace }}' does not exist. Do you want to create it? (y/n, default: n)"
        echo: true
        default: "n"
      register: create_namespace_prompt_result
      when: namespace_check.rc != 0 # Only prompt if namespace does not exist

    - name: Create Kubernetes namespace '{{ secret_namespace }}' if it doesn't exist and requested
      ansible.builtin.command: "kubectl create namespace {{ secret_namespace }}"
      when:
        - namespace_check.rc != 0 # Namespace does not exist
        - create_namespace_prompt_result.user_input | lower == 'y'
      register: namespace_creation_result

    - name: Fail if namespace does not exist and creation was not requested
      ansible.builtin.fail:
        msg: "Namespace '{{ secret_namespace }}' does not exist and you chose not to create it. Aborting."
      when:
        - namespace_check.rc != 0 # Namespace does not exist
        - create_namespace_prompt_result.user_input | lower != 'y'

    - name: Ensure secrets directory exists
      ansible.builtin.file:
        path: "{{ k8s_secrets_base_path }}"
        state: directory
        mode: '0755'

    - name: Generate Infisical Secret YAML file
      ansible.builtin.template:
        src: templates/infisical_secret.yml.j2
        dest: "{{ k8s_secrets_base_path }}/{{ secret_filename }}"
        mode: '0644'

    - name: Add new secret to kustomization.yaml resources
      ansible.builtin.lineinfile:
        path: "{{ k8s_secrets_base_path }}/kustomization.yaml"
        regexp: "^{{ secret_filename | regex_escape() }}$" # Ensure idempotency
        line: "  - {{ secret_filename }}"
        insertafter: "^resources:$"
        state: present
        create: true # Create kustomization.yaml if it doesn't exist
        backup: true # Create a backup before modifying
      register: kustomization_update

    - name: Debug - Kustomization update result
      ansible.builtin.debug:
        msg: "Kustomization updated: {{ kustomization_update.changed }}"
        verbosity: 1

    - name: Prompt to apply Kustomization
      ansible.builtin.pause:
        prompt: "Infisical Secret YAML and kustomization.yaml have been updated. Do you want to apply the Kustomization now? (y/n) [n]"
        echo: true
      register: apply_kustomization_prompt

    - name: Apply Kustomization
      ansible.builtin.command: "kubectl apply -k {{ k8s_secrets_base_path }}"
      when: apply_kustomization_prompt.user_input | lower == 'y'
      register: kustomization_apply_result
      changed_when: kustomization_apply_result.rc == 0
      failed_when: kustomization_apply_result.rc != 0

    - name: Display Kustomization apply result
      ansible.builtin.debug:
        var: kustomization_apply_result.stdout_lines
      when:
        - apply_kustomization_prompt.user_input | lower == 'y'
        - kustomization_apply_result is defined
