---
- name: Create PostgreSQL database via pigsty.yml (using lineinfile)
  hosts: dserver
  vars:
    pigsty_config_path: "/home/mohammad/k8s-vms/pigsty/pigsty_git" # Base path to Pigsty installation
    pigsty_file_location: "{{ pigsty_config_path }}/pigsty.yml" # Full path to pigsty.yml
    pg_cluster_name: "pg-meta" # Replace with your actual Pigsty cluster name
  vars_prompt:
    - name: "new_pg_database"
      prompt: "Enter the name for the new PostgreSQL database"
      private: false
    - name: "db_owner_user"
      prompt: "Enter the owner username for the new PostgreSQL database (must exist)"
      private: false
    - name: "db_comment"
      prompt: "Enter a comment for the new database (optional, leave blank for none)"
      private: false
      default: ""
    - name: "db_extensions_input"
      prompt: "Enter comma-separated extensions (e.g., 'vector,pg_stat_statements', leave blank for none)"
      private: false
      default: ""

  tasks:
    - name: Debug - Database input variables
      ansible.builtin.debug:
        msg:
          - "New Database: {{ new_pg_database }}"
          - "DB Owner: {{ db_owner_user }}"
          - "DB Comment: {{ db_comment }}"
          - "DB Extensions Input: {{ db_extensions_input }}"
        verbosity: 1

    - name: Check if database '{{ new_pg_database }}' already exists in pigsty.yml
      ansible.builtin.shell: >
        grep -iq "name: {{ new_pg_database }}" {{ pigsty_file_location }}
      register: db_exists_check
      delegate_to: dserver
      changed_when: false
      failed_when: false # grep returns 1 if not found, which is not a failure for us

    - name: Debug - Database existence check result
      ansible.builtin.debug:
        msg: "Database existence check RC: {{ db_exists_check.rc }}"
        verbosity: 1

    - name: Fail if database already exists
      ansible.builtin.fail:
        msg: "Database '{{ new_pg_database }}' already exists in {{ pigsty_file_location }}. Aborting."
      when: db_exists_check.rc == 0 # rc=0 means grep found the pattern

    - name: Check if user '{{ db_owner_user }}' already exists in pigsty.yml
      ansible.builtin.shell: >
        grep -iq "name: {{ db_owner_user }}" {{ pigsty_file_location }}
      register: user_exists_check
      delegate_to: dserver
      changed_when: false
      failed_when: false # grep returns 1 if not found, which is not a failure for us

    - name: Debug - User existence check result
      ansible.builtin.debug:
        msg: "User existence check RC: {{ user_exists_check.rc }}"
        verbosity: 1

    - name: Fail if user already exists
      ansible.builtin.fail:
        msg: "User '{{ db_owner_user }}' doesn't exists in {{ pigsty_file_location }}. Aborting."
      when: user_exists_check.rc == 1 # rc=0 means grep found the pattern

    - name: Construct new database entry as a single YAML line
      ansible.builtin.set_fact:
        new_db_yaml_line: >-
          - { name: {{ new_pg_database }}, owner: {{ db_owner_user }},
          comment: "{{ db_comment if db_comment | length > 0 else omit }}"
          {% if db_extensions_input | length > 0 %}, extensions: [{{ db_extensions_input | split(',') | map('trim') | map('community.general.json_query', '{ "name": @ }') | join(', ') }}] {% endif %} }

    - name: Debug - Constructed database YAML line
      ansible.builtin.debug:
        msg: "Constructed Database YAML Line: {{ new_db_yaml_line }}"
        verbosity: 1

    - name: Insert new database entry into pigsty.yml
      ansible.builtin.lineinfile:
        path: "{{ pigsty_file_location }}"
        insertafter: "^\\s*pg_databases:\\s*$" # Insert after the pg_databases: line
        line: "          {{ new_db_yaml_line }}" # Adjust indentation as needed
        state: present
      delegate_to: dserver

    - name: Debug - Lineinfile task result
      ansible.builtin.debug:
        var: ansible_results
        verbosity: 1
      when: ansible_verbosity > 1 # Only show detailed results if verbosity is higher

    - name: Prompt to run Pigsty deploy command
      ansible.builtin.pause:
        prompt: "pigsty.yml has been updated. Do you want to run the Pigsty deploy command to apply changes? (y/n) [n]"
        echo: true
      register: run_deploy_prompt

    - name: Debug - Deploy prompt result
      ansible.builtin.debug:
        msg: "User chose to run deploy: {{ run_deploy_prompt.user_input | lower == 'y' }}"
        verbosity: 1

    - name: Run Pigsty command to create database
      ansible.builtin.command: "bin/pgsql-db {{ pg_cluster_name }} {{ new_pg_database }}"
      args:
        chdir: "{{ pigsty_config_path }}"
      delegate_to: dserver
      when: run_deploy_prompt.user_input | lower == 'y'
