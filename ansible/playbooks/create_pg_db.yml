---
- name: Create PostgreSQL database via pigsty.yml (using lineinfile)
  hosts: dserver
  vars:
    pigsty_config_path: "/home/mohammad/k8s-vms/pigsty/pigsty_git" # Base path to Pigsty installation
    pigsty_file_location: "{{ pigsty_config_path }}/pigsty.yml" # Full path to pigsty.yml
    pg_cluster_name: "pg-meta" # Replace with your actual Pigsty cluster name
  vars_prompt:
    - name: "new_pg_database"
      prompt: "Enter the name for the new PostgreSQL database"
      private: false
    - name: "db_owner_user"
      prompt: "Enter the owner username for the new PostgreSQL database (must exist)"
      private: false
    - name: "db_comment"
      prompt: "Enter a comment for the new database (optional, leave blank for none)"
      private: false
      default: ""
    - name: "db_extensions_input"
      prompt: "Enter comma-separated extensions (e.g., 'vector,pg_stat_statements', leave blank for none)"
      private: false
      default: ""

  tasks:
    - name: Check if database '{{ new_pg_database }}' already exists in pigsty.yml
      ansible.builtin.shell: |
        grep -q "name: {{ new_pg_database }}" {{ pigsty_file_location }}
      register: db_exists_check
      delegate_to: dserver
      ignore_errors: true # grep returns non-zero if not found
      changed_when: false

    - name: Fail if database already exists
      ansible.builtin.fail:
        msg: "Database '{{ new_pg_database }}' already exists in {{ pigsty_file_location }}. Aborting."
      when: db_exists_check.rc == 0

    - name: Prepare extensions list
      ansible.builtin.set_fact:
        parsed_extensions: "{{ db_extensions_input.split(',') | map('trim') | select('length') | map('community.general.dict_from_keys', ['name']) | list }}"
      when: db_extensions_input | length > 0

    - name: Construct new database entry as a single YAML line
      ansible.builtin.set_fact:
        new_db_yaml_line: >-
          - { name: "{{ new_pg_database }}", owner: "{{ db_owner_user }}",
          comment: "{{ db_comment if db_comment | length > 0 else omit }}",
          encoding: UTF8, lc_collate: en_US.UTF-8, lc_ctype: en_US.UTF-8,
          template: template0, state: present
          {% if parsed_extensions is defined %}, extensions: {{ parsed_extensions | to_json }} {% endif %} }

    - name: Insert new database entry into pigsty.yml
      ansible.builtin.lineinfile:
        path: "{{ pigsty_file_location }}"
        insertafter: "^\\s*pg_databases:\\s*$" # Insert after the pg_databases: line
        line: "          {{ new_db_yaml_line }}" # Adjust indentation as needed
        state: present
      delegate_to: dserver

    - name: Prompt to run Pigsty deploy command
      ansible.builtin.pause:
        prompt: "pigsty.yml has been updated. Do you want to run the Pigsty deploy command to apply changes? (yes/no)"
      register: run_deploy_prompt

    - name: Run Pigsty command to create database
      ansible.builtin.command: "bin/pgsql-db {{ pg_cluster_name }} {{ new_pg_database }}"
      args:
        chdir: "{{ pigsty_config_path }}"
      delegate_to: dserver
      when: run_deploy_prompt.user_input | lower == 'yes'
