---
- name: Create PostgreSQL user via pigsty.yml
  hosts: dserver
  vars:
    pigsty_config_path: "/home/mohammad/k8s-vms/pigsty/pigsty_git" # Base path to Pigsty installation
    pigsty_file_location: "{{ pigsty_config_path }}/pigsty.yml" # Full path to pigsty.yml
    pg_cluster_name: "pg-meta" # Replace with your actual Pigsty cluster name
  vars_prompt:
    - name: "new_pg_user"
      prompt: "Enter the new PostgreSQL username to create"
      private: false
    - name: "new_pg_password"
      prompt: "Enter the password for the new PostgreSQL user"
      private: true # Keep this private for security
    - name: "pgbouncer_enabled"
      prompt: "Enable PGBouncer for this user? (yes/no, default: no)"
      private: false
      default: "no"
    - name: "conn_limit"
      prompt: "Enter connection limit for the user (-1 for no limit, default: -1)"
      private: false
      default: "-1"
    - name: "pool_conn_limit"
      prompt: "Enter pool connection limit for the user (-1 for no limit, default: -1)"
      private: false
      default: "-1"
    - name: "user_roles"
      prompt: "Enter comma-separated roles for the user (e.g., dbrole_readwrite, default: dbrole_readwrite)"
      private: false
      default: "dbrole_readwrite"
    - name: "expire_days"
      prompt: "Enter days until user expires (e.g., 3650 for 10 years, 0 for no expiry, default: 0)"
      private: false
      default: "0"

  tasks:
    - name: Read existing pigsty.yml from remote server
      ansible.builtin.slurp:
        src: "{{ pigsty_file_location }}"
      register: pigsty_yml_content
      delegate_to: dserver

    - name: Decode pigsty.yml content
      ansible.builtin.set_fact:
        pigsty_config: "{{ pigsty_yml_content['content'] | b64decode | from_yaml }}"

    - name: Ensure pg_users list exists for the cluster
      ansible.builtin.set_fact:
        pigsty_config: |
          {{ pigsty_config | combine(
            {'all': {'children': {pg_cluster_name: {'vars': {'pg_users': []}}}}},
            recursive=True
          ) }}
      when: pigsty_config.all.children[pg_cluster_name].vars.pg_users is not defined

    - name: Prepare new user entry
      ansible.builtin.set_fact:
        new_user_entry:
          name: "{{ new_pg_user }}"
          password: "{{ new_pg_password }}"
          state: present
          pgbouncer: "{{ pgbouncer_enabled | lower == 'yes' }}"
          connlimit: "{{ conn_limit | int }}"
          pool_connlimit: "{{ pool_conn_limit | int }}"
          roles: "{{ user_roles.split(',') | map('trim') | list }}"
          expire_in: "{{ expire_days | int }}"
      when: not (pigsty_config.all.children[pg_cluster_name].vars.pg_users | selectattr('name', 'equalto', new_pg_user) | list)

    - name: Add new user to pigsty_config if not present
      ansible.builtin.set_fact:
        pigsty_config: |
          {{ pigsty_config | combine(
            {'all': {'children': {pg_cluster_name: {'vars': {'pg_users':
              (pigsty_config.all.children[pg_cluster_name].vars.pg_users | default([])) + [new_user_entry]
            }}}}},
            recursive=True
          ) }}
      when: new_user_entry is defined # Only add if new_user_entry was prepared (i.e., user not already present)

    - name: Write updated pigsty.yml back to remote server
      ansible.builtin.copy:
        content: "{{ pigsty_config | to_yaml }}"
        dest: "{{ pigsty_file_location }}"
        mode: '0644'
      delegate_to: dserver

    - name: Prompt to run Pigsty deploy command
      ansible.builtin.pause:
        prompt: "pigsty.yml has been updated. Do you want to run the Pigsty deploy command to apply changes? (yes/no)"
      register: run_deploy_prompt

    - name: Run Pigsty command to create user
      ansible.builtin.command: "bin/pgsql-user {{ pg_cluster_name }} {{ new_pg_user }}"
      args:
        chdir: "{{ pigsty_config_path }}"
      delegate_to: dserver
      when: run_deploy_prompt.user_input | lower == 'yes'
