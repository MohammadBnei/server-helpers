---
- name: Create PostgreSQL user via pigsty.yml (using lineinfile)
  hosts: dserver
  vars:
    pigsty_config_path: "/home/mohammad/k8s-vms/pigsty/pigsty_git" # Base path to Pigsty installation
    pigsty_file_location: "{{ pigsty_config_path }}/pigsty.yml" # Full path to pigsty.yml
    pg_cluster_name: "pg-meta" # Replace with your actual Pigsty cluster name
  vars_prompt:
    - name: "new_pg_user"
      prompt: "Enter the new PostgreSQL username to create"
      private: false
    - name: "new_pg_password"
      prompt: "Enter the password for the new PostgreSQL user"
      private: true # Keep this private for security
    - name: "pgbouncer_enabled"
      prompt: "Enable PGBouncer for this user? (yes/no, default: yes)"
      private: false
      default: "yes"
    - name: "conn_limit"
      prompt: "Enter connection limit for the user (-1 for no limit, default: -1)"
      private: false
      default: "-1"
    - name: "pool_conn_limit"
      prompt: "Enter pool connection limit for the user (-1 for no limit, default: -1)"
      private: false
      default: "-1"
    - name: "user_roles"
      prompt: "Enter comma-separated roles for the user (e.g., dbrole_readwrite, default: dbrole_readwrite)"
      private: false
      default: "dbrole_readwrite"
    - name: "expire_days"
      prompt: "Enter days until user expires (e.g., 3650 for 10 years, 0 for no expiry, default: 0)"
      private: false
      default: "0"

  tasks:
    - name: Check if user '{{ new_pg_user }}' already exists in pigsty.yml
      ansible.builtin.shell: "grep -E '^- \\{ name: \"?{{ new_pg_user }}\"?' {{ pigsty_file_location }} > /dev/null && echo 'found' || echo 'not_found'"
      register: user_exists_check_result
      delegate_to: dserver
      changed_when: false

    - name: Fail if user already exists
      ansible.builtin.fail:
        msg: "User '{{ new_pg_user }}' already exists in {{ pigsty_file_location }}. Aborting."
      when: user_exists_check_result.stdout == 'found'

    - name: Construct new user entry as a single YAML line
      ansible.builtin.set_fact:
        new_user_yaml_line: >-
          - { name: "{{ new_pg_user }}", password: "{{ new_pg_password }}", state: present, pgbouncer: {{ pgbouncer_enabled | lower == 'yes' }}, connlimit: {{ conn_limit | int }}, pool_connlimit: {{ pool_conn_limit | int }}, roles: {{ user_roles.split(',') | map('trim') | list | to_json }}, expire_in: {{ expire_days | int }} }

    - name: Insert new user entry into pigsty.yml
      ansible.builtin.lineinfile:
        path: "{{ pigsty_file_location }}"
        insertafter: "^\\s*pg_users:\\s*$" # Insert after the pg_users: line
        line: "          {{ new_user_yaml_line }}" # Adjust indentation as needed
        state: present
      delegate_to: dserver

    - name: Prompt to run Pigsty deploy command
      ansible.builtin.pause:
        prompt: "pigsty.yml has been updated. Do you want to run the Pigsty deploy command to apply changes? (y/n)"
        default: "n"
        echo: true
      register: run_deploy_prompt

    - name: Run Pigsty command to create user
      ansible.builtin.command: "bin/pgsql-user {{ pg_cluster_name }} {{ new_pg_user }}"
      args:
        chdir: "{{ pigsty_config_path }}"
      delegate_to: dserver
      when: run_deploy_prompt.user_input | lower == 'y'
