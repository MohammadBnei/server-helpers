---
- name: Create PostgreSQL user via pigsty.yml (using lineinfile)
  hosts: dserver
  vars:
    pigsty_config_path: "/home/mohammad/k8s-vms/pigsty/pigsty_git" # Base path to Pigsty installation
    pigsty_file_location: "{{ pigsty_config_path }}/pigsty.yml" # Full path to pigsty.yml
    pg_cluster_name: "pg-meta" # Replace with your actual Pigsty cluster name
  vars_prompt:
    - name: "new_pg_user"
      prompt: "Enter the new PostgreSQL username to create"
      private: false
    - name: "new_pg_password"
      prompt: "Enter the password for the new PostgreSQL user"
      private: true # Keep this private for security
    - name: "pgbouncer_enabled"
      prompt: "Enable PGBouncer for this user? (y/n, default: y)"
      private: false
      default: "y"
    - name: "conn_limit"
      prompt: "Enter connection limit for the user (-1 for no limit, default: -1)"
      private: false
      default: "-1"
    - name: "pool_conn_limit"
      prompt: "Enter pool connection limit for the user (-1 for no limit, default: -1)"
      private: false
      default: "-1"
    - name: "user_roles"
      prompt: "Enter comma-separated roles for the user (e.g., dbrole_readwrite, default: dbrole_readwrite)"
      private: false
      default: "dbrole_readwrite"
    - name: "expire_days"
      prompt: "Enter days until user expires (e.g., 3650 for 10 years, -1 for no expiry, default: -1)"
      private: false
      default: "-1"

  tasks:
    - name: Debug - User input variables
      ansible.builtin.debug:
        msg:
          - "New User: {{ new_pg_user }}"
          - "PGBouncer Enabled: {{ pgbouncer_enabled }}"
          - "Conn Limit: {{ conn_limit }}"
          - "Pool Conn Limit: {{ pool_conn_limit }}"
          - "User Roles: {{ user_roles }}"
          - "Expire Days: {{ expire_days }}"
        verbosity: 1

    - name: Check if user '{{ new_pg_user }}' already exists in pigsty.yml
      ansible.builtin.shell: >
        grep -iq "name: {{ new_pg_user }}" {{ pigsty_file_location }}
      register: user_exists_check
      delegate_to: dserver
      changed_when: false
      failed_when: false # grep returns 1 if not found, which is not a failure for us

    - name: Debug - User existence check result
      ansible.builtin.debug:
        msg: "User existence check RC: {{ user_exists_check.rc }}"
        verbosity: 1

    - name: Fail if user already exists
      ansible.builtin.fail:
        msg: "User '{{ new_pg_user }}' already exists in {{ pigsty_file_location }}. Aborting."
      when: user_exists_check.rc == 0 # rc=0 means grep found the pattern

    - name: Construct new user entry as a single YAML line
      ansible.builtin.set_fact:
        new_user_yaml_line: >-
          - { name: {{ new_pg_user }}, password: {{ new_pg_password }}, pgbouncer: {{ (pgbouncer_enabled | lower == 'y') | to_json }}, connlimit: {{ conn_limit | int }}, pool_connlimit: {{ pool_conn_limit | int }}, roles: {{ user_roles.split(',') | map('trim') | list | to_json }}, expire_in: {{ expire_days | int }} }

    - name: Debug - Constructed user YAML line
      ansible.builtin.debug:
        msg: "Constructed User YAML Line: {{ new_user_yaml_line }}"
        verbosity: 1
        
    - name: Insert new user entry into pigsty.yml
      ansible.builtin.lineinfile:
        path: "{{ pigsty_file_location }}"
        insertafter: "^\\s*pg_users:\\s*$" # Insert after the pg_users: line
        line: "          {{ new_user_yaml_line }}" # Adjust indentation as needed
        state: present
      delegate_to: dserver

    - name: Debug - Lineinfile task result
      ansible.builtin.debug:
        var: ansible_results
        verbosity: 1
      when: ansible_verbosity > 1 # Only show detailed results if verbosity is higher

    - name: Prompt to run Pigsty deploy command
      ansible.builtin.pause:
        prompt: "pigsty.yml has been updated. Do you want to run the Pigsty deploy command to apply changes? (y/n) [n]"
        echo: true
      register: run_deploy_prompt

    - name: Debug - Deploy prompt result
      ansible.builtin.debug:
        msg: "User chose to run deploy: {{ run_deploy_prompt.user_input | lower == 'y' }}"
        verbosity: 1

    - name: Run Pigsty command to create user
      ansible.builtin.command: "bin/pgsql-user {{ pg_cluster_name }} {{ new_pg_user }}"
      args:
        chdir: "{{ pigsty_config_path }}"
      delegate_to: dserver
      when: run_deploy_prompt.user_input | lower == 'y'
